#include<stdio.h>

#include<stdlib.h>

#include<time.h>

#include<conio.h>



int suiji()

{

	srand(time(0));

	return (rand() % 4);

}



void suiji24(int a[4][4])

{

	int i, j, k, l;

	k = 0;

	int b[16][2];

	for (i = 0; i<4; i++)

	{

		for (j = 0; j<4; j++)

		{

			if (a[i][j] == 0)

			{

				b[k][0] = i;

				b[k++][1] = j;

			}

		}

	}

	srand(time(0));

	l = rand() % k;

	i = b[l][0];

	j = b[l][1];

	if (suiji() % 2 == 0)

		a[i][j] = 2;

	else

		a[i][j] = 4;

}



void set(int a[4][4])

{

	int i,j;

	for (i = 0; i < 4; i++)//初始化棋盘

	{

		for (j = 0; j < 4; j++)

		{

			a[i][j] = 0;

		}

	}

	suiji24(a);

	suiji24(a);

}

void print_num(int a[4][4], int m, int n)

{

	if (a[m][n] == 0)

	{

		printf("     ");

	}

	else

	{

		printf("%5d", a[m][n]);

	}

}

void print(int a[4][4])

{

	printf("————————————— ");

	printf("|"); print_num(a, 0, 0); printf("|"); print_num(a, 0, 1); printf("|"); print_num(a, 0, 2); printf("|"); print_num(a, 0, 3); printf("|\n");

	printf("————————————— ");

	printf("|"); print_num(a, 1, 0); printf("|"); print_num(a, 1, 1); printf("|"); print_num(a, 1, 2); printf("|"); print_num(a, 1, 3); printf("|\n");

	printf("————————————— ");

	printf("|"); print_num(a, 2, 0); printf("|"); print_num(a, 2, 1); printf("|"); print_num(a, 2, 2); printf("|"); print_num(a, 2, 3); printf("|\n");

	printf("————————————— ");

	printf("|"); print_num(a, 3, 0); printf("|"); print_num(a, 3, 1); printf("|"); print_num(a, 3, 2); printf("|"); print_num(a, 3, 3); printf("|\n");

	printf("————————————— ");

}



int change(int a[4][4],char i)

{

	int k, j, top,left,right;

	int b[4];

	int c[4][4];

	for (j = 0; j < 4; j++)

	{

		for (k = 0; k < 4; k++)

		{

			c[j][k] = a[j][k];

		}

	}

	if (i == 'w')

	{

		for (k = 0; k < 4; k++)

		{

			top = -1;

			for (j = 0; j < 4; j++)

				b[j] = 0;

			for (j = 3; j > -1; j--)

			{

				if (a[j][k] != 0)

				{

					top = top + 1;

					b[top] = a[j][k];

				}

			}

				for (j = 0; j < 4; j++)

				{

					if (top > -1)

					{

						if (top!=0&&b[top] == b[top - 1])

						{

							a[j][k] = 2 * b[top];

							top = top - 2;

						}

						else

						{

							a[j][k] = b[top--];

						}

					}

					else

					{

						a[j][k] = 0;

					}

				}

		}

	}

	if (i == 's')

	{

		for (k = 0; k < 4; k++)

		{

			top = -1;

			for (j = 0; j < 4; j++)

				b[j] = 0;

			for (j = 0; j < 4; j++)

			{

				if (a[j][k] != 0)

				{

					top = top + 1;

					b[top] = a[j][k];

				}

			}

				for (j = 3; j > -1; j--)

				{

					if (top > -1)

					{

						if (top!=0&&b[top] == b[top - 1])

						{

							a[j][k] = 2 * b[top];

							top = top - 2;

						}

						else

						{

							a[j][k] = b[top--];

						}

					}

					else

					{

						a[j][k] = 0;

					}

				}

		}

	}

	if (i == 'a')

	{

		for (j = 0; j < 4; j++)

		{

			left = right = 0;

			for (k = 0; k < 4; k++)

				b[k] = 0;

			for (k = 0; k < 4; k++)

			{

				if (a[j][k] != 0)

				{

					b[right++] = a[j][k];

				}

			}

			for (k = 0; k < 4; k++)

			{

				if (left<right)

				{

					if (left != 3 && b[left] == b[left + 1])

					{

						a[j][k] = 2 * b[left];

						left = left + 2;

					}

					else

					{

						a[j][k] = b[left++];

					}

				}

				else

				{

					a[j][k] = 0;

				}

			}

		}

	}

	if (i == 'd')

	{

		for (j = 0; j < 4; j++)

		{

			for (k = 0; k < 4; k++)

				b[k] = 0;

			left = right = 0;

			for (k = 3; k > -1; k--)

			{

				if (a[j][k] != 0)

				{

					b[right++] = a[j][k];

					

				}

			}

				for (k = 3; k > -1; k--)

				{

					if (left<right)

					{

						if (left != 3 && b[left] == b[left + 1])

						{

							a[j][k] = 2 * b[left];

							left = left + 2;

						}

						else

						{

							a[j][k] = b[left++];

						}

					}

					else

					{

						a[j][k] = 0;

					}

				}

		}

	}

	for (j = 0; j < 4; j++)

	{

		for (k = 0; k < 4; k++)

		{

			if (a[j][k] != c[j][k])

			{

				return 1;

			}

		}

	}

	return 0;

}

char change_num(int j) {

	char i;

	if (j == 72 || j == 119)

		i = 'w';

	if (j == 80 || j == 115)

		i = 's';

	if (j == 75 || j == 97)

		i = 'a';

	if (j == 77 || j == 100)

		i = 'd';

	return i;

}



void scan(int a[4][4])

{

	char i;

	int j;

	j = getch();



	/*scanf("%c", &i);

	getchar();*/

	system("cls");//清屏

	if (j == 224)

		j = getch();

	i = change_num(j);

	if(change(a, i))

	suiji24(a);

}



int isover(int a[4][4])

{

	int i,j;

	for (i = 0; i < 4; i++)

	{

		for (j = 0; j < 4; j++)

		{

			if (a[i][j] == 2048)

			{

				return 1;

			}

			if (a[i][j] == 0)

			{

				return 0;

			}

		}

	}

      for (i = 0; i < 3; i++)

	   {

		  for (j = 0; j < 3; j++)

		   {

			   if (a[i][j] == a[i + 1][j] || a[i][j] == a[i][j + 1])

			   {

			    	return 0;

		    	}

		   }

	   }

	  for (i = 0; i < 3; i++)

	  {

		  if (a[3][i] == a[3][i + 1])

		  {

			  return 0;

		  }

		  if (a[i][3] == a[i + 1][3])

		  {

			  return 0;

		  }

	  }

	return 2;

}



void welcome()

{

	printf("\n");

	printf("----------|  |----------|  |           |  |----------|\n");

	printf("          |  |          |  |           |  |          |\n");

	printf("          |  |          |  |           |  |          |\n");

	printf("----------|  |          |  |-----------|  |----------|\n");

	printf("|            |          |              |  |          |\n");

	printf("|            |          |              |  |          |\n");

	printf("|----------  |----------|              |  |----------|\n");

	printf("\n\n使用w.s.a.d或者方向键来控制方向 \n\n");

	printf("powered by cz\n\n\n");

	system("pause");

	system("cls");

}



int main()

{

	int a[4][4];

	int i;

	i = 0;

	welcome();

	set(a);

	print(a);

	while (!i)

	{

		

		scan(a);

		print(a);

		i = isover(a);

	}

	if (i == 1)

	{

		printf("you win!\n ");

		system("pause");

	}

	if (i == 2)

	{

		printf("you lose!\n");

		system("pause");

	}

	return 0;

}
